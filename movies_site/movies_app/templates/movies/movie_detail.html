{% extends 'base.html' %}
{% block content %}

<div class="container mx-auto mt-8">
    <div class="flex flex-col md:flex-row gap-6">
        <!-- Poster -->
        <div class="md:w-1/3">
            <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="rounded-lg shadow-lg w-full">
        </div>

        <!-- Details -->
        <div class="md:w-2/3">
            <h1 class="text-4xl font-bold mb-4">{{ movie.title }}</h1>
            <p class="mb-2"><strong>Category:</strong> {{ movie.category.name }}</p>
            <p class="mb-2"><strong>Release Date:</strong> {{ movie.release_date }}</p>
            <p class="mb-2"><strong>Actors:</strong> {{ movie.actors }}</p>
            <p class="mb-2"><strong>Rating:</strong> {{ movie.rating }}/10</p>
            <p class="mb-4">{{ movie.description }}</p>

            <!-- Trailer -->
            {% if movie.trailer_url %}
            <div class="mb-4">
                <iframe width="100%" height="315" src="{{ movie.trailer_url }}" frameborder="0" allowfullscreen></iframe>
            </div>
            {% endif %}

            <!-- Favorites -->
            {% if user.is_authenticated %}
                <form action="{% url 'toggle_favorite' movie.slug %}" method="POST">
                    {% csrf_token %}
                    {% if is_favorited %}
                        <button type="submit" class="btn btn-danger w-full">Remove from Favorites</button>
                    {% else %}
                        <button type="submit" class="btn btn-custom w-full">Add to Favorites</button>
                    {% endif %}
                </form>
            {% endif %}

            <!-- Edit/Delete buttons for owner -->
            {% if user == movie.created_by %}
                <div class="mt-4 flex gap-2">
                    <a href="{% url 'movie_update' movie.slug %}" class="btn btn-custom flex-1">Edit</a>
                    <a href="{% url 'movie_delete' movie.slug %}" class="btn btn-danger flex-1">Delete</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Comments Section -->
    <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Comments</h2>

        {% if user.is_authenticated %}
        <form action="{% url 'add_comment' movie.slug %}" method="POST" class="mb-6">
            {% csrf_token %}
            {{ comment_form.content }}
            <button type="submit" class="btn btn-custom mt-2">Post Comment</button>
        </form>
        {% else %}
            <p class="mb-4">Please <a href="{% url 'login' %}" class="text-blue-500">login</a> to comment.</p>
        {% endif %}

        <div class="space-y-4">
            {% for comment in movie.comments.all %}
            <div class="bg-gray-900 p-4 rounded-lg shadow">
                <p class="font-semibold">{{ comment.user.username }} <span class="text-gray-400 text-sm">{{ comment.created_at }}</span></p>
                <p>{{ comment.content }}</p>
                {% if user == comment.user or user.is_staff %}
                <form action="{% url 'delete_comment' comment.pk %}" method="POST" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger text-sm">Delete</button>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <p>No comments yet.</p>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
